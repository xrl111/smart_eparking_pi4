{% extends "base.html" %}

{% block title %}Admin Dashboard - Smart E-Parking{% endblock %}

{% block content %}
<main class="container">
  <header>
    <h1>ğŸš— Smart E-Parking System - Admin</h1>
    <p>Báº£ng Ä‘iá»u khiá»ƒn quáº£n trá»‹ viÃªn</p>
    <div class="system-status" id="system-status">
      <span class="status-indicator" id="status-indicator"></span>
      <span id="status-text">Äang káº¿t ná»‘i...</span>
      <span id="arduino-status" style="margin-left: 16px; font-size: 0.9rem;"></span>
    </div>
  </header>

  <section class="stats">
    <div class="stat-card">
      <span class="label">Tá»•ng chá»— Ä‘á»—</span>
      <strong id="total-slots">{{ total_slots }}</strong>
    </div>
    <div class="stat-card">
      <span class="label">Chá»— trá»‘ng</span>
      <strong id="free-slots">0</strong>
    </div>
    <div class="stat-card">
      <span class="label">Äang Ä‘á»—</span>
      <strong id="active-sessions">0</strong>
    </div>
    <div class="stat-card">
      <span class="label">Tá»•ng lÆ°á»£t Ä‘á»— hÃ´m nay</span>
      <strong id="today-sessions">0</strong>
    </div>
  </section>

  <section>
    <h2>ğŸ“Š Danh sÃ¡ch chá»— Ä‘á»—</h2>
    <div class="slots" id="slots">
      <div class="loading-container" style="text-align: center; padding: 40px">
        <div class="loading"></div>
        <p>Äang táº£i dá»¯ liá»‡u...</p>
      </div>
    </div>
  </section>

  <section>
    <h2>âš™ï¸ Cháº¿ Ä‘á»™ hoáº¡t Ä‘á»™ng</h2>
    <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div>
          <h3 style="margin: 0 0 8px 0;">Cháº¿ Ä‘á»™ hiá»‡n táº¡i</h3>
          <div id="current-mode" style="font-size: 1.2rem; font-weight: 600;">
            <span id="mode-badge" style="padding: 8px 16px; border-radius: 8px; color: white;"></span>
            <span id="mode-description" style="margin-left: 12px; color: #6b7280;"></span>
          </div>
        </div>
        <div>
          <button id="btn-mode-auto" class="btn btn-primary" style="margin-right: 8px;">ğŸ”„ AUTO</button>
          <button id="btn-mode-manual" class="btn btn-secondary">âœ‹ MANUAL</button>
        </div>
      </div>
      <div id="mode-warning" style="padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; display: none;">
        <strong>âš ï¸ LÆ°u Ã½:</strong> <span id="mode-warning-text"></span>
      </div>
    </div>

  <section>
    <h2>ğŸ›ï¸ Äiá»u khiá»ƒn há»‡ thá»‘ng</h2>
    <div class="manual-controls" id="manual-controls-section">
      <div class="control-group">
        <h3>Barrier Control</h3>
        <button id="btn-gate-open" class="btn btn-success">ğŸ”“ Má»Ÿ Barrier</button>
        <button id="btn-gate-close" class="btn btn-danger">ğŸ”’ ÄÃ³ng Barrier</button>
        <p id="gate-control-hint" style="color: #6b7280; font-size: 0.9rem; margin-top: 8px;"></p>
      </div>
      <div class="control-group">
        <h3>Slot Management</h3>
        <div id="slot-controls">
          <p style="color: #6b7280; margin: 0">Äang táº£i...</p>
        </div>
      </div>
      <div class="control-group">
        <h3>System Test</h3>
        <button id="btn-refresh" class="btn btn-primary">ğŸ”„ LÃ m má»›i</button>
      </div>
    </div>
  </section>

  <section>
    <h2>ğŸ“‹ Lá»‹ch sá»­ Ä‘á»— xe</h2>
    <div id="history" style="background: white; border-radius: 12px; padding: 16px; max-height: 400px; overflow-y: auto;">
      <p style="color: #6b7280;">Äang táº£i...</p>
    </div>
  </section>

  <section>
    <h2>ğŸ“‹ ThÃ´ng bÃ¡o há»‡ thá»‘ng</h2>
    <ul id="errors">
      <li>KhÃ´ng cÃ³ thÃ´ng bÃ¡o.</li>
    </ul>
  </section>
</main>

<script>
// Override fetchStatus to use authenticated endpoint
async function fetchStatus() {
  try {
    const res = await fetch('/api/status');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    render(data);
    
    // Update admin-specific stats
    if (data.active_sessions !== undefined) {
      document.getElementById('active-sessions').textContent = data.active_sessions;
    }
    if (data.today_sessions !== undefined) {
      document.getElementById('today-sessions').textContent = data.today_sessions;
    }
    
    // Update mode display (náº¿u cÃ³ thÃ´ng tin mode trong response)
    if (data.mode !== undefined || data.is_auto !== undefined) {
      updateModeDisplay(data);
    } else {
      // Náº¿u khÃ´ng cÃ³ trong status, fetch riÃªng
      fetch('/api/mode')
        .then(res => res.json())
        .then(modeData => updateModeDisplay(modeData))
        .catch(err => console.error('Lá»—i khi load mode:', err));
    }
    
    updateConnectionStatus('online');
    lastUpdateTime = data.last_update;
    return data;
  } catch (err) {
    console.error('Lá»—i:', err);
    updateConnectionStatus('offline');
    return null;
  }
}

// Load history
async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    const data = await res.json();
    const container = document.getElementById('history');
    
    if (data.sessions && data.sessions.length > 0) {
      container.innerHTML = data.sessions.map(s => `
        <div style="padding: 12px; border-bottom: 1px solid #f3f4f6;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <strong>Slot ${s.slot_id + 1}</strong>
              ${s.vehicle_plate ? `<br><small>Biá»ƒn sá»‘: ${s.vehicle_plate}</small>` : ''}
              ${s.user ? `<br><small>NgÆ°á»i dÃ¹ng: ${s.user}</small>` : ''}
              <br><small>VÃ o: ${new Date(s.entry_time).toLocaleString('vi-VN')}</small>
              ${s.exit_time ? `<br><small>Ra: ${new Date(s.exit_time).toLocaleString('vi-VN')}</small>` : ''}
              ${s.duration_minutes ? `<br><small>Thá»i gian: ${s.duration_minutes} phÃºt</small>` : ''}
            </div>
            <span style="background: ${s.status === 'active' ? '#22c55e' : '#6b7280'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
              ${s.status === 'active' ? 'Äang Ä‘á»—' : 'ÄÃ£ hoÃ n thÃ nh'}
            </span>
          </div>
        </div>
      `).join('');
    } else {
      container.innerHTML = '<p style="color: #6b7280; text-align: center;">ChÆ°a cÃ³ lá»‹ch sá»­.</p>';
    }
  } catch (err) {
    console.error('Lá»—i khi táº£i lá»‹ch sá»­:', err);
  }
}

// Mode management
function updateModeDisplay(data) {
  const mode = data.mode || 'auto';
  const isManual = mode === 'manual';
  const isAuto = mode === 'auto';
  
  const badge = document.getElementById('mode-badge');
  const description = document.getElementById('mode-description');
  const warning = document.getElementById('mode-warning');
  const warningText = document.getElementById('mode-warning-text');
  const gateHint = document.getElementById('gate-control-hint');
  
  // Update badge
  if (isAuto) {
    badge.textContent = 'ğŸ”„ AUTO';
    badge.style.background = '#3b82f6';
    description.textContent = 'Arduino tá»± Ä‘á»™ng Ä‘iá»u khiá»ƒn dá»±a trÃªn cáº£m biáº¿n';
    gateHint.textContent = 'âš ï¸ Cháº¿ Ä‘á»™ AUTO: Arduino Ä‘iá»u khiá»ƒn barrier tá»± Ä‘á»™ng. Chuyá»ƒn sang MANUAL Ä‘á»ƒ Ä‘iá»u khiá»ƒn thá»§ cÃ´ng.';
    gateHint.style.color = '#f59e0b';
  } else {
    badge.textContent = 'âœ‹ MANUAL';
    badge.style.background = '#6b7280';
    description.textContent = 'Äiá»u khiá»ƒn thá»§ cÃ´ng tá»« web dashboard';
    gateHint.textContent = 'âœ“ Cháº¿ Ä‘á»™ MANUAL: Báº¡n cÃ³ thá»ƒ Ä‘iá»u khiá»ƒn barrier vÃ  slot tá»« Ä‘Ã¢y.';
    gateHint.style.color = '#22c55e';
  }
  
  // Update warning
  if (isManual && data.locked_by) {
    warning.style.display = 'block';
    warningText.textContent = `Cháº¿ Ä‘á»™ MANUAL Ä‘ang Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi: ${data.locked_by}`;
  } else {
    warning.style.display = 'none';
  }
  
  // Enable/disable manual controls
  const manualControls = document.getElementById('manual-controls-section');
  if (isManual) {
    manualControls.style.opacity = '1';
    manualControls.style.pointerEvents = 'auto';
  } else {
    manualControls.style.opacity = '0.6';
    manualControls.style.pointerEvents = 'none';
  }
  
  // Update button states (chá»‰ disable náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ Ä‘Ã³)
  const btnAuto = document.getElementById('btn-mode-auto');
  const btnManual = document.getElementById('btn-mode-manual');
  
  if (btnAuto) {
    btnAuto.disabled = isAuto;
    btnAuto.style.opacity = isAuto ? '0.5' : '1';
  }
  if (btnManual) {
    btnManual.disabled = isManual;
    btnManual.style.opacity = isManual ? '0.5' : '1';
  }
}

async function changeMode(mode) {
  const btnAuto = document.getElementById('btn-mode-auto');
  const btnManual = document.getElementById('btn-mode-manual');
  
  // Disable buttons while processing
  if (btnAuto) btnAuto.disabled = true;
  if (btnManual) btnManual.disabled = true;
  
  try {
    const res = await fetch('/api/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode }),
    });
    
    const data = await res.json();
    if (res.ok) {
      showToast(`ÄÃ£ chuyá»ƒn sang cháº¿ Ä‘á»™ ${mode.toUpperCase()}`, 'success');
      
      // Cáº­p nháº­t mode display ngay láº­p tá»©c
      const modeInfo = {
        mode: mode,
        is_auto: mode === 'auto',
        is_manual: mode === 'manual',
        arduino_control: mode === 'auto',
        web_control: mode === 'manual',
      };
      updateModeDisplay(modeInfo);
      
      // Refresh toÃ n bá»™ status sau má»™t chÃºt Ä‘á»ƒ Ä‘áº£m báº£o server Ä‘Ã£ cáº­p nháº­t
      setTimeout(() => {
        fetchStatus();
      }, 300);
    } else {
      showToast(`Lá»—i: ${data.error || 'KhÃ´ng thá»ƒ chuyá»ƒn cháº¿ Ä‘á»™'}`, 'error');
      // Re-enable buttons on error
      if (btnAuto) btnAuto.disabled = false;
      if (btnManual) btnManual.disabled = false;
    }
  } catch (err) {
    console.error('Lá»—i khi chuyá»ƒn cháº¿ Ä‘á»™:', err);
    showToast('Lá»—i káº¿t ná»‘i khi chuyá»ƒn cháº¿ Ä‘á»™', 'error');
    // Re-enable buttons on error
    if (btnAuto) btnAuto.disabled = false;
    if (btnManual) btnManual.disabled = false;
  }
}

// Setup mode buttons
document.addEventListener('DOMContentLoaded', () => {
  const btnAuto = document.getElementById('btn-mode-auto');
  const btnManual = document.getElementById('btn-mode-manual');
  
  if (btnAuto) {
    btnAuto.addEventListener('click', () => changeMode('auto'));
  }
  if (btnManual) {
    btnManual.addEventListener('click', () => changeMode('manual'));
  }
  
  // Load initial mode
  fetch('/api/mode')
    .then(res => res.json())
    .then(data => updateModeDisplay(data))
    .catch(err => console.error('Lá»—i khi load mode:', err));
});

// Load history on page load
loadHistory();
setInterval(loadHistory, 15000); // Refresh every 15 seconds
</script>
{% endblock %}

